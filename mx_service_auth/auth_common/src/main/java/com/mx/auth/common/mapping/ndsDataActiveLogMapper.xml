<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mx.auth.common.dao.NdsDataActiveLogDao">

    <insert id="insertNdsDataActiveLog">
        insert into te_nds_data_active_log(
        id,
        product_id,
        device_no,
        soft_ver,
        data_ver,
        region_code,
        active_time,
        active_code,
        active_type,
        active_source
        )
        values(
        #{id},
        #{product_id},
        #{device_no},
        #{soft_ver},
        #{data_ver},
        #{region_code},
        #{active_time},
        #{active_code},
        #{active_type},
        #{active_source}
        )
    </insert>

    <select id="getNdsDataActiveLogManage" resultType="com.mx.auth.common.model.NdsDataActiveLog">
        select * from te_nds_data_active_log
        where 1=1
        <if test="id != null and id != ''">
            and id = #{id}
        </if>
        <if test="product_id != null and product_id != ''">
            and product_id = #{product_id}
        </if>
        <if test="device_no != null and device_no != ''">
            and device_no = #{device_no}
        </if>
        <if test="region_code != null and region_code != ''">
            and region_code = #{region_code}
        </if>
        <if test="active_type != null and active_type != ''">
            and active_type = #{active_type}
        </if>
        <if test="active_source != null and active_source != ''">
            and active_source = #{active_source}
        </if>
    </select>

    <select id="getActiveLogInfo" resultType="com.mx.auth.common.model.NdsDataActiveLog">
        SELECT *
        FROM te_nds_data_active_log
        where 1=1
        <if test="device_no != null and device_no != ''">
            and device_no = #{device_no}
        </if>
        <if test="region_id != null and region_id != ''">
            and region_id = #{region_id}
        </if>
    </select>

    <select id="getSerialNumberInfo" resultType="com.mx.auth.common.model.NdsDataActiveLog">
        SELECT act_time,
        device_no,
        device_serial_num,
        service_date,
        act_code,
        data_ver,
        CASE active_type WHEN '1' THEN '新装'
        WHEN '3' THEN '升级' END as active_type
        FROM te_nds_data_active_log
        where active_type in ('1','3')
        <if test="device_no != null and device_no != ''">
            and device_no = #{device_no}
        </if>
        <if test="device_serial_num != null and device_serial_num != ''">
            and device_serial_num = #{device_serial_num}
        </if>
        <if test="act_time != null and act_time != ''">
            and act_time = #{act_time}
        </if>
    </select>

    <select id="getFirstActivate" resultType="com.mx.auth.common.model.NdsDataActiveLog">
        SELECT *
        FROM te_nds_data_active_log
        where device_no = #{device_no}
        and active_type = '1'
        and region_id = '5600'
    </select>

    <update id="updateActiveLogByChangeDevice">
        update te_nds_data_active_log set
        device_no = #{new_device_no}
        where device_no = #{old_device_no}
        and product_id = #{product_id}
    </update>

    <select id="retrieveActLog" resultType="com.mx.auth.common.model.NdsDataActiveLog">
        SELECT a.*, b.vin, b.user_name, b.mobile_phone
        FROM te_nds_data_active_log a JOIN te_device_info b ON a.device_no = b.device_no
        WHERE 1=1
        <if test="order_id != null and order_id != ''">
            AND a.id = #{order_id}
        </if>
        <if test="startDate != null and startDate != ''">
            AND a.active_time &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND a.active_time &lt; #{endDate}
        </if>
        <if test="active_type != null and active_type != ''">
            AND a.active_type = #{active_type}
        </if>
        <if test="product_id != null and product_id != ''">
            AND b.product_id = #{product_id}
        </if>
        <if test="device_no != null and device_no != ''">
            AND b.device_no = #{device_no}
        </if>
        <if test="vin != null and vin != ''">
            AND b.vin = #{vin}
        </if>
        <if test="user_name != null and user_name != ''">
            AND b.user_name = #{user_name}
        </if>
        <if test="phone != null and phone != ''">
            AND b.mobile_phone = #{phone}
        </if>
        ORDER BY a.active_time DESC
    </select>


</mapper>