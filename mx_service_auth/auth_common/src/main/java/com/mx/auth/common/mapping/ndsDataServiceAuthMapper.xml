<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mx.auth.common.dao.NdsDataServiceAuthDao">

    <select id="getCountByOrderId" resultType="int">
        SELECT count(*) from te_nds_data_service_auth
        where auth_order_id = #{order_id}
    </select>

    <!-- 插入服务鉴权数据 -->
    <insert id="insert">
    	INSERT INTO te_nds_data_service_auth(
            auth_id,
            product_id,
            device_no,
            auth_order_id,
            region_code,
            start_time,
            end_time,
            init_nums,
            nums,
            years,
            data_ver,
            auth_type,
            auth_rule,
            business_mode
    	)
    	VALUES(
            #{auth_id},
            #{product_id},
            #{device_no},
            #{auth_order_id},
            #{region_code},
            #{start_time},
            #{end_time},
            #{init_nums},
            #{nums},
            #{years},
            #{data_ver},
            #{auth_type},
            #{auth_rule},
            #{business_mode}
    	)
    </insert>

    <!-- 查询收费权限最大结束时间 -->
    <select id="getNdsMaxEndTimeNotFree" resultType="String">
        SELECT max(end_time) from te_nds_data_service_auth
        where product_id = #{product_id}
        and device_no = #{device_no}
        and region_id = #{region_id}
        and is_active = '1'
        and auth_type = '2'
        and end_time >= now()
        and nums != '0'
    </select>

    <!-- 验证免费鉴权服务是否过期 -->
    <select id="getNdsAuthTypeFree" resultType="com.mx.auth.common.model.NdsDataServiceAuth">
        SELECT * from te_nds_data_service_auth
        where product_id = #{product_id}
        and device_no = #{device_no}
        and region_id = #{region_id}
        and is_active = '1'
        and auth_type = '1'
        and end_time >= now()
        and nums != '0'
    </select>

    <!-- 更新免费服务鉴权记录的结束时间 -->
    <update id="updateNdsAuthEndDate">
        UPDATE te_nds_data_service_auth SET
            end_time = date_add(now(), interval -1 day)
        WHERE product_id = #{product_id}
        AND device_no = #{device_no}
        AND region_code = #{region_code}
        AND auth_type = '1'
        AND end_time >= now()
        AND nums != '0'
    </update>
    
    <select id="getByDeviceNo" resultType="com.mx.auth.common.model.NdsDataServiceAuth">
        SELECT * FROM te_nds_data_service_auth
        WHERE product_id = #{product_id}
        AND device_no = #{device_no}
    	AND region_code = '5600'
    	AND nums > 0
    	AND auth_type = 1 /*1:免费权限  2:收费权限*/
    	AND (end_time IS NULL OR end_time >= now())
    </select>

    <select id="checkDeviceNo" resultType="java.lang.Integer">
        select count(*) from te_nds_data_service_auth
        where device_no = #{device_no}
    </select>

    <update id="updateStartEndTime">
        update te_nds_data_service_auth set
        end_time = #{end_time},
        start_time = #{start_time}
        where auth_id = #{auth_id}
    </update>

    <update id="updateNums">
    	update te_nds_data_service_auth set
    	available_num = #{available_num}
    	where auth_id = #{auth_id}
    </update>

    <select id="checkDeviceNoUpgrade" resultType="Int">
        SELECT count(*) FROM te_nds_data_service_auth
        WHERE device_no = #{device_no}
        AND start_time IS NOT NULL
        AND end_time IS NOT NULL
        AND end_time >= now()
        AND nums != '0'
        AND auth_type = '1'
    </select>
    
    <select id="getNdsDataServiceAuthManage" resultType="com.mx.auth.common.model.NdsDataServiceAuth">
        SELECT * FROM te_nds_data_service_auth
        WHERE 1=1
        <if test = "auth_id != null and auth_id != ''">
           and auth_id = #{auth_id}
        </if>
        <if test = "product_id != null and product_id != ''">
           and product_id = #{product_id}
        </if>
        <if test = "device_no != null and device_no != ''">
           and device_no = #{device_no}
        </if>
        <if test = "region_code != null and region_code != ''">
           and region_code = #{region_code}
        </if>
        <if test = "auth_order_id != null and auth_order_id != ''">
           and auth_order_id = #{auth_order_id}
        </if>
        <if test = "auth_rule != null and auth_rule != ''">
           and auth_rule = #{auth_rule}
        </if>
        <if test = "business_mode != null and business_mode != ''">
           and business_mode = #{business_mode}
        </if>
    </select>
    
    
	<update id="updateAuthByChangeDevice">
        update te_nds_data_service_auth set
        device_no = #{new_device_no}
        where device_no = #{old_device_no}
        and product_id = #{product_id}
    </update>
</mapper>
